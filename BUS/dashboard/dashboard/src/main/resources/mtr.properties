mtr.logAsspect.InsertLog=false
mtr.logAsspect.ControllerTimeCheck=false
mtr.logAsspect.ControllerStartTime=07:50:00
mtr.logAsspect.ControllerEndTime=21:30:00
mtr.auth.ip=172.16.112.42,172.16.112.54
mtr.auth.check=false 

mtr.apicheck.recv.phoneNo=01038443140
mtr.apicheck.send.phoneNo=0237745918

#	한글깨짐 조치
#    	String a = getCompositeConfiguration().getString(key);
#       return new String(a.getBytes("ISO-8859-1"),"UTF-8");
#




#연령대별 사고집계
 mtr.query.filter_getAccidentAge= \
	SELECT m.age_gb,sum(m.tot_cnt) AS tot_cnt,sum(m.tot_amt) AS tot_amt \
	FROM ( \
		SELECT CASE \
					WHEN k.baseYear <= 30             THEN '30세 이하' \
					WHEN k.baseYear BETWEEN 31 AND 40 THEN '30 ~ 40세' \
					WHEN k.baseYear BETWEEN 41 AND 45 THEN '41 ~ 45세' \
					WHEN k.baseYear BETWEEN 46 AND 50 THEN '46 ~ 50세' \
					WHEN k.baseYear BETWEEN 51 AND 55 THEN '51 ~ 55세' \
					WHEN k.baseYear BETWEEN 56 AND 60 THEN '56 ~ 60세' \
					WHEN k.baseYear BETWEEN 61 AND 65 THEN '61 ~ 65세' \
					WHEN k.baseYear BETWEEN 66 AND 69 THEN '66 ~ 69세' \
					ELSE '70세 이상' \
				END AS age_gb \
			,k.tot_cnt \
			,k.tot_amt \
		FROM ( \
			SELECT 	to_char(SYSDATE,'YYYY') - CONVERT(b.ageYear,int) AS baseYear \
				,	count(*) AS tot_cnt \
				,	sum(a.OUT_TOT_AMT)  AS tot_amt \
			FROM 	TBM_ACCIDENT_INFO a ,( \
				SELECT emp_nm, CASE WHEN  substring(b.emp_regno,8,1) IN ('1','2') THEN '19' || substring(emp_regno,1,2) \
									ELSE  '20' || substring(emp_regno,1,2) END AS ageYear \
				FROM TBL_EMPLOYEEINFO b where b.COMPANY_NO ='@companyNo' \
				) b \
			WHERE 	a.COMPANY_NO ='@companyNo' \
			AND 	a.ACC_DATE between '@fromDate-01' and '@toDate-31' \
			AND 	a.EMP_NM  = b.EMP_NM \
			GROUP BY to_char(SYSDATE,'YYYY') - CONVERT(b.ageYear,int) \
		) k \
	) m \
	GROUP BY m.age_gb

 mtr.query.filter_getAccidentEnterDate= \
 	SELECT m.age_gb,sum(m.tot_cnt) AS tot_cnt,sum(m.tot_amt) AS tot_amt \
	FROM ( \
		SELECT k.baseYear \
			,   CASE \
					WHEN k.baseYear <= 1             THEN '1년 이하' \
					WHEN k.baseYear BETWEEN 1 AND 20 THEN k.baseYear \
					ELSE '2' \
				END AS age_gb \
			,k.tot_cnt \
			,k.tot_amt \
		FROM ( \
			SELECT 	b.ageYear baseYear \
				,	count(*) AS tot_cnt \
				,	sum(a.OUT_TOT_AMT)  AS tot_amt \
			FROM 	TBM_ACCIDENT_INFO a ,( \
				SELECT emp_nm \
					, 	round(nvl(to_char(datediff(DAY,b.enter_date,to_char(SYSDATE,'yyyy-mm-dd'))),0) / 365,0 ) AS ageYear \
				FROM TBL_EMPLOYEEINFO b where b.COMPANY_NO ='@companyNo' \
				) b \
			WHERE 	a.COMPANY_NO ='@companyNo' \
			AND 	a.ACC_DATE between '@fromDate-01' and '@toDate-31' \
			AND 	a.EMP_NM  = b.EMP_NM \
			GROUP BY b.ageYear \
		) k \
	) m \
	GROUP BY m.age_gb
	
#근속년차별 사고집계
 mtr.query.filter_getAccidentEnterDate2= \
	SELECT m.age_gb,sum(m.tot_cnt) AS tot_cnt,sum(m.tot_amt) AS tot_amt \
	FROM ( \
		SELECT k.baseYear, CASE \
					WHEN k.baseYear < 1             THEN '1년 이하' \
					WHEN k.baseYear BETWEEN 1 AND 20 THEN k.baseYear || '년차' \
					ELSE '20년 이상' \
				END AS age_gb \
			,k.tot_cnt \
			,k.tot_amt \
		FROM ( \
			SELECT 	b.ageYear baseYear \
				,	count(*) AS tot_cnt \
				,	sum(a.OUT_TOT_AMT)  AS tot_amt \
			FROM 	TBM_ACCIDENT_INFO a ,( \
				SELECT emp_nm \
					, 	round(nvl(to_char(datediff(DAY,b.enter_date,to_char(SYSDATE,'yyyy-mm-dd'))),0) / 365,0 ) AS ageYear \
				FROM TBL_EMPLOYEEINFO b where b.COMPANY_NO ='@companyNo' \
				) b \
			WHERE 	a.COMPANY_NO ='@companyNo' \
			AND 	a.ACC_DATE between '@fromDate-01' and '@toDate-31' \
			AND 	a.EMP_NM  = b.EMP_NM \
			GROUP BY b.ageYear \
		) k \
	) m \
	GROUP BY m.age_gb \
	ORDER BY m.baseYear

#운행기록 월별통계
 mtr.query.filter_getEmpWorkingTimeRouteAvg= \
	SELECT 	k.route_nm \
		,	count(k.emp_nm)	AS emp_cnt \
		,	sum(k.avg_min) AS tot_minute \
		,	sum(k.avg_km) AS tot_km \
		, 	round(sum(k.avg_min)/count(k.emp_nm)) AS avg_minute \
		, 	round(sum(k.avg_km)/count(k.emp_nm)) AS avg_km \
	FROM ( \
		SELECT 	a.route_nm \
			, 	a.emp_nm \
			,	SUBSTRING(a.work_date,1,7) AS base_Ym \
			, 	sum(a.day_work_min) 	AS tot_min \
			,	count(a.work_Date) AS tot_cnt \
			,	sum(a.day_work_min) / count(a.work_Date) AS avg_min \
			, 	sum(a.day_work_km) 	AS tot_km \
			,	sum(a.day_work_km) / count(a.work_date) AS avg_km \
		FROM 	TBB_DRIVING_RECORD_DAY a \
		WHERE 	a.company_no = '@companyNo' \
		AND 	a.work_date LIKE '@baseYm' || '%' \
		GROUP BY a.route_nm,a.emp_nm,SUBSTRING(a.work_date,1,7) \
	) k,tbl_routeinfo b \
	WHERE k.route_nm = b.route_nm \
	and   k.tot_cnt > @checkDay \
	GROUP BY k.route_nm

 mtr.query.filter_getEmpWorkingTimeRouteAvg2= \
	SELECT 	k.route_nm \
		,	count(k.emp_nm)	AS emp_cnt \
		,	sum(k.avg_min) AS tot_min \
		, 	round(sum(k.avg_min)/count(k.emp_nm)) AS avg_min \
	FROM ( \
		SELECT 	a.route_nm \
			, 	a.emp_nm \
			,	SUBSTRING(a.work_date,1,7) AS base_Ym \
			, 	sum(a.day_work_min) 	AS tot_min \
			,	count(a.work_Date) AS tot_cnt \
			,	sum(a.day_work_min) / count(a.work_Date) AS avg_min \
		FROM 	TBB_DRIVING_RECORD_DAY a \
		WHERE 	a.company_no = '@companyNo' \
		AND 	a.work_date LIKE '@baseYm' || '%' \
		GROUP BY a.route_nm,a.emp_nm,SUBSTRING(a.work_date,1,7) \
	) k,tbl_routeinfo b \
	WHERE k.route_nm = b.route_nm \
	and   k.tot_cnt > @checkDay \
	GROUP BY k.route_nm


 mtr.query.filter_getEmpWorkingKMRouteAvg= \
	SELECT 	k.route_nm \
		,	count(k.emp_nm)	AS emp_cnt \
		,	sum(k.avg) AS tot_km \
		, 	round(sum(k.avg)/count(k.emp_nm)) AS avg_km \
	FROM ( \
		SELECT 	a.route_nm \
			, 	a.emp_nm \
			,	SUBSTRING(a.work_date,1,7) AS base_Ym \
			, 	sum(a.day_work_km) 	AS tot_km \
			,	count(a.work_Date) AS tot_cnt \
			,	sum(a.day_work_km) / count(a.work_date) AS avg \
		FROM 	TBB_DRIVING_RECORD_DAY a \
		WHERE 	a.company_no = '@companyNo' \
		AND 	a.work_date LIKE '@baseYm' || '%' \
		GROUP BY a.route_nm,a.emp_nm,SUBSTRING(a.work_date,1,7) \
	) k,tbl_routeinfo b \
	WHERE k.route_nm = b.route_nm \
	and   k.tot_cnt > @checkDay \
	GROUP BY k.route_nm


#운행기록 월별통계
 mtr.query.filter_getDrivingRecord_year= \
	WITH wholeAvgInfo AS ( \
		SELECT 	k.base_ym \
			,	round(avg(k.bms_km),2) AS wholeAvg_bms_km \
			,	round(avg(k.tot_min),2) AS wholeAvg_tot_min \
		FROM ( \
			SELECT	a.base_ym,a.WORK_DATE ,a.driver_id,	sum(a.BMS_KM) bms_km ,	sum(a.TOT_MIN) tot_min \
			FROM	TBL_DRIVING_RECORD a \
			where 	a.company_no = '@companyNo' \
			and 	a.BASE_YM between  '@fromDate' and '@toDate' \
			GROUP BY	a.base_ym,a.WORK_DATE,a.driver_id \
		) k	\
		GROUP BY k.base_ym \
	) \
	SELECT 	k.base_ym \
		, 	count(k.base_ym) as tot_day \
		,	round(sum(k.bms_km),2) AS bms_km \
		, 	round(sum(k.tot_min),2) AS tot_min \
		,	round(avg(k.bms_km),2) AS avg_bms_km \
		,	round(avg(k.tot_min),2) AS avg_tot_min \
		,	m.wholeAvg_bms_km \
		,	m.wholeAvg_tot_min \
	FROM ( \
		SELECT	a.base_ym, a.WORK_DATE ,	sum(a.BMS_KM) bms_km ,	sum(a.TOT_MIN) tot_min \
		FROM	TBL_DRIVING_RECORD a \
		JOIN 	TBL_ISC_DRIVER_INFO b ON	a.company_no = b.COMPANY_NO  AND b.EMP_NM = '@empNm'	AND b.DRIVER_ID = a.DRIVER_ID \
		where 	a.company_no = '@companyNo' \
		AND     a.BASE_YM between  '@fromDate' and '@toDate' \
		GROUP BY	a.base_ym,a.WORK_DATE \
	) k JOIN wholeAvgInfo m ON m.base_ym = k.base_ym \
	GROUP BY k.base_ym



#운행기록 일간통계
 mtr.query.filter_getDrivingRecord_month= \
	SELECT 	/* filter_getDrivingRecord_month */ \
			WORK_DATE \
		,	CASE WHEN substring(min(START_TIME),12) > '12:00:00' THEN 'P' ELSE 'A' END AS ampm_gb \
		,	substring(min(START_TIME),12) AS start_time \
		,	count(WORK_DATE) AS tot_cnt \
		,	round(sum(a.BMS_KM),2) bms_km \
		,	sum(a.TOT_MIN) tot_min \
	FROM 	TBL_DRIVING_RECORD a JOIN TBL_ISC_DRIVER_INFO b ON b.EMP_NM  = '@empNm' AND b.DRIVER_ID = a.DRIVER_ID \
	where 	a.company_no = '@companyNo' \
	AND   	a.BASE_YM = '@baseYm' \
	GROUP BY WORK_DATE
	
#운행기록 특정일
 mtr.query.filter_getDrivingRecord_day= \
	SELECT 	ROWNUM as no, a.CAR_REGNO ,substring(a.START_TIME,12) as START_TIME,substring(a.END_TIME,12) as END_TIME ,round(a.BMS_KM,2) as bms_km ,a.TOT_MIN \
	FROM 	TBL_DRIVING_RECORD a JOIN TBL_ISC_DRIVER_INFO b ON b.EMP_NM  = '@empNm' AND b.DRIVER_ID = a.DRIVER_ID \
	where 	a.company_no = '@companyNo' \
	AND   	a.WORK_DATE = '@baseYmd' \
	ORDER BY a.START_TIME
	
 
#노선별 배차순번 거리조회
 mtr.query.filter_getFixedInitSeq= \
	SELECT 	DISTINCT INIT_SEQ  \
   	FROM 	TBL_MONTH_ARRANGE_BASIC a \
   	WHERE	a.COMPANY_NO = '@companyNo' \
	AND 	a.BASE_YM = '@baseYm' \
	AND 	a.route_nm = '@routeNm' \
	AND 	a.INIT_SEQ > 0
	
#노선별 배차순번 거리조회
 mtr.query.filter_selectRouteSeqDistance= \
 SELECT ROUTE_NM \
 	,	(SELECT max(HOLDING_CNT ) FROM   TBL_ROUTEINFO WHERE company_no= '100') AS maxcnt \
	, 	listagg(k.seq ,',') WITHIN group(ORDER BY k.ROUTE_NM) AS seq \
	,	listagg(k.DISTANCE  ,',') WITHIN group(ORDER BY k.ROUTE_NM) AS distance \
 FROM 	TBM_ROUTE_SEQ_DISTANCE_INFO k \
 WHERE 	COMPANY_NO  = '@companyNo' \
 GROUP BY ROUTE_NM \
 ORDER BY 1


#배차정시성 월별 자료현황
 mtr.query.filter_selectMonthlyPunctuality= \
 WITH datainfo AS ( \
	select	k.ROUTE_NM \
		,	listagg(k.dd ,',') WITHIN group(ORDER BY k.ROUTE_NM) AS dd \  
		,	listagg(k.cnt1 ,',') WITHIN group(ORDER BY k.ROUTE_NM) AS cnt1 \  
		,	listagg(k.cnt2 ,',') WITHIN group(ORDER BY k.ROUTE_NM) AS cnt2 \
	FROM ( \
		SELECT DAY(a.base_ymd) dd,	a.route_nm, max(a.cnt1) AS cnt1,max(a.cnt2) AS cnt2 \
		FROM ( \
			select	base_ymd \
			    ,	ROUTE_NM \
				,	count(*) AS cnt1\
				,	0 AS cnt2 \
			FROM    TBL_ARRANGE_PUNCTUALITY_INFO a \
			WHERE 	COMPANY_NO  = '@companyNo' \
			AND 	BASE_YMD LIKE '@baseYm%' \
			GROUP BY BASE_YMD ,ROUTE_NM  \
		UNION \
			select	base_ymd \
				,	ROUTE_NM \
				,	0 AS cnt1 \
				,	count(*) AS cnt2 \
			FROM    TBL_ARRANGE_PUNCTUALITY_ANALIZE a \
			WHERE 	COMPANY_NO  = '@companyNo' \
			AND 	BASE_YMD LIKE '@baseYm%' \
			GROUP BY BASE_YMD ,ROUTE_NM \
		) a \
		GROUP BY a.base_ymd,a.route_nm \
	) k \
	 GROUP BY k.ROUTE_NM \
 ) \
	SELECT  listagg(k.day ,',') WITHIN group(ORDER BY k.key) AS column_A \  
		,	listagg(k.week||k.HOLIDAY_YN ,',') WITHIN group(ORDER BY k.key) AS column_B \
		,	'' AS column_C \
		,	'' AS column_D \
	FROM ( \
		        SELECT '1' KEY,p.DAY,p.date \
		               ,		decode(p.week,1,'일',2,'월',3,'화',4,'수',5,'목',6,'금',7,'토') AS week \
		        		,	nvl(c.HOLIDAY_YN,'') AS HOLIDAY_YN \
		        	FROM ( \
		        	       SELECT t.n AS day \
			                       ,       day_of_week(dateadd(DAY,t.n-1,DATE'@baseFirstYmd')) AS week \
			                       ,       formatdatetime(dateadd(DAY,t.n-1,DATE'@baseFirstYmd'),'yyyy-MM-dd') AS date \
			               FROM T \
			               WHERE dateadd(DAY,t.n,DATE'@baseFirstYmd') <= DATE'@nextMonthYmd' \
			        ) p LEFT OUTER JOIN  tbm_holiday_info c \
		        			ON  c.COMPANY_NO = '@companyNo' \
		        			AND p.date = c.WORK_DATE \
	) k \
	GROUP BY k.key \
	union \
	SELECT a.ROUTE_NM ,b.dd,b.cnt1,b.cnt2 \
	FROM TBL_ROUTEINFO a	LEFT OUTER JOIN  datainfo b ON b.route_nm = a.ROUTE_NM \
	WHERE a.COMPANY_NO = '@companyNo'
	

#휴일조회  
 mtr.query.filter_selectHolidayInfo= \
	SELECT a.* ,a.work_date as key,rownum as id \
	FROM TBM_Holiday_INFO a \
	where 	a.company_no = '@companyNo' \
    AND 	a.work_date   like substr('@workDate',1,4) || '%' \
	order by a.work_date

#위험운전행동 분석 기사별  
 mtr.query.filter_danagerAnal_Driver= \
	WITH ymInfo AS ( \
		SELECT DISTINCT base_ym FROM TBL_DANGER_DRIVING_INFO a \
		WHERE a.company_no = '@companyNo' \
		AND   a.base_ym between '@fromDate' and '@toDate' \
	),empinfo AS ( \
		SELECT  DISTINCT emp_nm ,route_nm , sp_gb FROM TBL_DANGER_DRIVING_INFO a \
		WHERE a.company_no = '@companyNo' \
		AND   a.base_ym between '@fromDate' and '@toDate' \
	),targetInfo AS ( \
		SELECT a.*,b.* FROM ymInfo a JOIN empinfo b \
	)	 \
	SELECT a.emp_nm, a.sp_gb \ 
		,	listagg(a.base_ym,',') WITHIN group(ORDER BY base_ym) AS base_ym \
		,	listagg(a.danger_level,',') WITHIN group(ORDER BY base_ym) AS rate \ 
		,	listagg(a.danger_level_no,',') WITHIN group(ORDER BY base_ym) AS danger_level_no \
		,	sum(danger_level_no)  AS total \
	FROM (	SELECT 	x.base_ym \
				,	x.emp_nm \
				,	x.sp_gb \
				,	x.route_nm \
				,	nvl(b.danger_level,'-')  AS danger_level \
				,	decode(b.danger_level,'매우위험',5,'위험',4,'주의',3,'보통',2,'양호',1,0)  AS danger_level_no \
			FROM targetInfo x  LEFT OUTER join TBL_DANGER_DRIVING_INFO b \
				on x.emp_nm = b.emp_nm \
				AND x.base_ym = b.base_ym \
				and b.company_no = '@companyNo' \
	) a \
	where a.route_nm = decode ('@routeNm','',a.route_nm, '@routeNm') \
	GROUP BY a.emp_nm \
	ORDER BY 1


#위험운전행동 분석 구간별  
 mtr.query.filter_danagerAnal_Step= \
	SELECT a.danger_level \ 
		,	decode(a.danger_level,'매우위험',5,'위험',4,'주의',3,'보통',2,'양호',1,0)  AS danger_level_no \
		,	listagg(a.base_ym,',') WITHIN group(ORDER BY base_ym) AS base_ym \
		,	listagg(a.danger_cnt||'(' || a.rate || '%)',',') WITHIN group(ORDER BY base_ym) AS rate \
		,	sum(danger_cnt)  AS total \
	FROM ( \
			SELECT a.* \
				,	ROUND( (danger_cnt / SUM(danger_cnt) OVER (PARTITION BY base_ym)),2) RATe \
			FROM (	\
				SELECT 	b.base_ym \
					,	b.danger_level \
					,	sum(CASE WHEN b.ROUTE_NM = NULL THEN 0  WHEN b.ROUTE_NM = decode('@routeNm','',b.ROUTE_NM ,'@routeNm') THEN 1 ELSE 0 END) AS danger_cnt \
				FROM TBL_DANGER_DRIVING_INFO b  \
				where b.company_no = '@companyNo' \
				AND   b.base_ym between '@fromDate' and '@toDate' \
				GROUP BY b.base_ym,b.danger_level \
			) a \
			union	 \
			SELECT 	b.base_ym \
				,	'합계' \
				,	sum(CASE  WHEN b.ROUTE_NM = NULL THEN 0 WHEN b.ROUTE_NM = decode('@routeNm','',b.ROUTE_NM ,'@routeNm') THEN 1 ELSE 0 END) AS danger_cnt \
				,	0 \
			FROM TBL_DANGER_DRIVING_INFO b \
			where b.company_no = '@companyNo' \
			AND   b.base_ym between '@fromDate' and '@toDate' \
			GROUP BY b.base_ym \
	) a \
	GROUP BY a.danger_level \
	ORDER BY 2 desc



#위험운전행동 분석 구간별  
 mtr.query.filter_danagerAnal_Employee= \
	SELECT 	b.base_ym, b.emp_nm,b.danger_km100,b.DANGER_ACT_CNT, b.DANGER_ACT,b.DANGER_LEVEL,b.DRIVING_CNT,b.DRIVING_DISTANCE,b.DRIVING_TIME \
	FROM TBL_DANGER_DRIVING_INFO b \
	where b.company_no = '@companyNo' \
	AND   b.base_ym between '@fromDate' and '@toDate' \
	AND   b.emp_nm = '@empNm' \
	ORDER BY b.base_ym desc

#위험운전행동 분석 구간별  (인사카드용 최근 3년치)
 mtr.query.filter_danagerAnal_Employee2= \
	SELECT 	b.base_ym, b.emp_nm,b.danger_km100,b.DANGER_ACT_CNT, b.DANGER_ACT,b.DANGER_LEVEL,b.DRIVING_CNT,b.DRIVING_DISTANCE,b.DRIVING_TIME \
	FROM TBL_DANGER_DRIVING_INFO b \
	where b.company_no = '@companyNo' \
	AND   b.base_ym > TO_CHAR(DATEADD(YEAR,-3,SYSDATE()),'yyyy-MM') \
	AND   b.emp_nm = '@empNm' \
	ORDER BY b.base_ym desc
		
	
#일별 배차상세조회
 mtr.query.filter_dailyArrangeInfo= \
 SELECT k.*,e.phone_no,e.email,e.emp_no \
 FROM ( \
		 SELECT a.CAR_REGNO ,a.EMP_NM ,'-' as value,REGEXP_REPLACE(a.@checkDay,'[*0-9@]','') AS ampm,convert(REGEXP_REPLACE(a.@checkDay,'[*ap@]',''),int) AS seq \
		 FROM 	TBL_MONTH_ARRANGE_DETAIL a \
		 WHERE 	a.company_no = '@companyNo' \
		 AND 	a.route_nm = '@routeNm' \
		 AND    a.BASE_Ym = '@baseYm' \
		 AND    a.CAR_REGNO  NOT LIKE 'SP%' \
		 AND 	a.@checkDay NOT LIKE '%*%' \
		 AND 	a.@checkDay NOT LIKE '%@%' \
		 AND    a.DISPATCH_SEQ = 6 \
		 AND    a.INIT_SEQ = 0 \
		 UNION ALL \
		 SELECT a.CAR_REGNO ,b.EMP_NM ,decode(b.EMP_NM,NULL,'-','SP') AS value,REGEXP_REPLACE(a.@checkDay,'[*0-9@-]','') AS ampm,convert(REGEXP_REPLACE(a.@checkDay,'[*ap@-]',''),int) AS seq \
		 FROM 	TBL_MONTH_ARRANGE_DETAIL a LEFT OUTER JOIN TBL_MONTH_ARRANGE_DETAIL b \
							 on     a.COMPANY_NO =b.COMPANY_NO \
							 AND 	a.ROUTE_NM = b.ROUTE_NM \
							 AND 	a.BASE_YM  = b.BASE_YM \
							 AND 	a.DISPATCH_SEQ = b.DISPATCH_SEQ \
							 AND 	a.INIT_SEQ = b.INIT_SEQ \
							 AND    b.CAR_REGNO LIKE 'SP%' \
							 AND    b.@checkDay <>'' \
							 AND 	a.@checkDay LIKE b.@checkDay || '%' \
		WHERE	a.company_no = '@companyNo'  \
		AND 	a.route_nm = '@routeNm' \
		AND     a.BASE_Ym = '@baseYm' \
		AND     a.CAR_REGNO  NOT LIKE 'SP%' \
		AND 	(a.@checkDay LIKE '%*%' OR a.@checkDay LIKE '%@%') \
		AND     a.DISPATCH_SEQ = 6 \
	    AND     a.INIT_SEQ = 0 \
 ) k left outer join tbl_employeeInfo e \
 on k.emp_nm = e.emp_nm \
 AND 	e.company_no = '100' \
 ORDER BY 4 ,5

mtr.query.filter_dailyArrangeInfo_old= \
	SELECT  b.CAR_REGNO ,a.EMP_NM ||'*' AS EMP_NM ,a.@checkDay, REGEXP_REPLACE(a.@checkDay,'[*0-9@]','') AS ampm,convert(REGEXP_REPLACE(a.@checkDay,'[*ap@]',''),int) AS seq \
	 FROM 	TBL_MONTH_ARRANGE_DETAIL a ,TBL_MONTH_ARRANGE_DETAIL b \
	 WHERE 	a.company_no = '@companyNo' \
	 AND 	a.route_nm = '@routeNm' \
	 AND    a.BASE_Ym = '@baseYm' \
	 AND    a.CAR_REGNO  LIKE 'SP%'\
	 AND    a.DISPATCH_SEQ = 6 \
	 AND    a.COMPANY_NO =b.COMPANY_NO \
	 AND 	a.ROUTE_NM = b.ROUTE_NM \
	 AND 	a.BASE_YM  = b.BASE_YM \
	 AND 	a.DISPATCH_SEQ = b.DISPATCH_SEQ \
	 AND    b.CAR_REGNO NOT LIKE 'SP%' \
	 AND 	b.@checkDay LIKE a.@checkDay || '%' \
	 UNION ALL \
	 SELECT a.CAR_REGNO ,a.EMP_NM ,a.@checkDay,REGEXP_REPLACE(a.@checkDay,'[*0-9@]','') AS ampm,convert(REGEXP_REPLACE(a.@checkDay,'[*ap@]',''),int) AS seq \
	 FROM 	TBL_MONTH_ARRANGE_DETAIL a \
	 WHERE 	a.company_no = '@companyNo' \
	 AND 	a.route_nm = '@routeNm' \
	 AND    a.BASE_Ym = '@baseYm' \
	 AND    a.CAR_REGNO  NOT LIKE 'SP%' \
	 AND 	a.@checkDay NOT LIKE '%-' \
	 AND    a.DISPATCH_SEQ = 6  \
	 ORDER BY 4,5 
	 

# 노선배차설정
 mtr.query.filter_getRouteInfoDetail= \
	SELECT 	a.ROUTE_NM \
		,	a.auto_cnt as tot_count \
		,	max(CASE WHEN REDUCT_WEEK = 7 THEN REDUCT_COUNT ELSE 0 END) sat_count \
		,	max(CASE WHEN REDUCT_WEEK = 1 THEN REDUCT_COUNT ELSE 0 END) sun_count \
		,   'N' as bit \
	FROM TBL_ROUTEINFO a LEFT OUTER JOIN TBM_ROUTE_REDUCTION_INFO b \
			ON  	a.COMPANY_NO = b.COMPANY_NO  \
			AND 	a.ROUTE_NM = b.ROUTE_NM  \
	GROUP BY a.ROUTE_NM ,a.auto_cnt		\
	ORDER BY 1

# 노선배차조회_ampm구분별
mtr.h2.BUS_monthArrangeDetail_ampm= \
    WITH RECURSIVE countera(n) AS ( \
		WITH routeCount AS ( \
		SELECT 'a' ampm_gubun, a.AUTO_CNT FROM TBL_ROUTEINFO a \
			WHERE 	a.COMPANY_NO  = '@companyNo' \
			AND 	a.ROUTE_NM    = '@routeNm'	 \
		union \
			SELECT 'p' ampm_gubun, a.AUTO_CNT FROM TBL_ROUTEINFO a \
			WHERE 	a.COMPANY_NO  = '@companyNo' \
			AND 	a.ROUTE_NM    = '@routeNm' \
		) \
	  	SELECT t.n+1,t.n as no,c.ampm_gubun,to_char(t.n,'00') || c.ampm_gubun AS gubun \
 				,  CASE WHEN a.ampm_gubun = '' AND a.d1 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d1 ,'[*@?]') and a.d1  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d1        \
				,  CASE WHEN a.ampm_gubun = '' AND a.d2  like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d2  ,'[*@?]') and a.d2   like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d2     \
				,  CASE WHEN a.ampm_gubun = '' AND a.d3  like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d3  ,'[*@?]') and a.d3   like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d3     \
				,  CASE WHEN a.ampm_gubun = '' AND a.d4  like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d4  ,'[*@?]') and a.d4   like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d4     \
				,  CASE WHEN a.ampm_gubun = '' AND a.d5  like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d5  ,'[*@?]') and a.d5   like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d5     \
				,  CASE WHEN a.ampm_gubun = '' AND a.d6  like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d6  ,'[*@?]') and a.d6   like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d6     \
				,  CASE WHEN a.ampm_gubun = '' AND a.d7  like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d7  ,'[*@?]') and a.d7   like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d7     \
				,  CASE WHEN a.ampm_gubun = '' AND a.d8  like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d8  ,'[*@?]') and a.d8   like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d8     \
				,  CASE WHEN a.ampm_gubun = '' AND a.d9  like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d9  ,'[*@?]') and a.d9   like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d9     \
				,  CASE WHEN a.ampm_gubun = '' AND a.d10 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d10 ,'[*@?]') and a.d10  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d10    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d11 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d11 ,'[*@?]') and a.d11  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d11    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d12 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d12 ,'[*@?]') and a.d12  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d12    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d13 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d13 ,'[*@?]') and a.d13  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d13    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d14 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d14 ,'[*@?]') and a.d14  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d14    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d15 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d15 ,'[*@?]') and a.d15  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d15    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d16 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d16 ,'[*@?]') and a.d16  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d16    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d17 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d17 ,'[*@?]') and a.d17  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d17    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d18 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d18 ,'[*@?]') and a.d18  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d18    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d19 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d19 ,'[*@?]') and a.d19  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d19    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d20 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d20 ,'[*@?]') and a.d20  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d20    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d21 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d21 ,'[*@?]') and a.d21  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d21    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d22 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d22 ,'[*@?]') and a.d22  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d22    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d23 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d23 ,'[*@?]') and a.d23  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d23    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d24 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d24 ,'[*@?]') and a.d24  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d24    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d25 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d25 ,'[*@?]') and a.d25  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d25    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d26 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d26 ,'[*@?]') and a.d26  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d26    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d27 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d27 ,'[*@?]') and a.d27  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d27    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d28 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d28 ,'[*@?]') and a.d28  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d28    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d29 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d29 ,'[*@?]') and a.d29  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d29    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d30 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d30 ,'[*@?]') and a.d30  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d30    \
				,  CASE WHEN a.ampm_gubun = '' AND a.d31 like t.n || c.ampm_gubun ||'%' THEN emp_nm ||'*' WHEN not REGEXP_LIKE(a.d31 ,'[*@?]') and a.d31  like t.n || c.ampm_gubun  THEN EMP_NM ELSE '' END d31    \
      FROM t ,TBL_MONTH_ARRANGE_DETAIL a , routeCount c \
    	WHERE 	a.COMPANY_NO  = '@companyNo' \
    	AND 	a.ROUTE_NM    = '@routeNm' \
    	AND 	a.BASE_YM = '@baseYm' \
    	AND 	a.dispatch_seq = 6 \
    	AND     a.init_seq = @initSeq \
    	AND     t.n <= c.auto_cnt \
    ) \
    SELECT 	decode(ampm_gubun,'a','오전','오후') as ampm_gubun , no as seq,0 as cnt \
    	,	max(d1 ) as d1 \
    	,	max(d2 ) as d2 \
    	,	max(d3 ) as d3 \
    	,	max(d4 ) as d4 \
    	,	max(d5 ) as d5 \
    	,	max(d6 ) as d6 \
    	,	max(d7 ) as d7 \
    	,	max(d8 ) as d8 \
    	,	max(d9 ) as d9 \
    	,	max(d10) as d10 \
    	,	max(d11) as d11 \
    	,	max(d12) as d12 \
    	,	max(d13) as d13 \
    	,	max(d14) as d14 \
    	,	max(d15) as d15 \
    	,	max(d16) as d16 \
    	,	max(d17) as d17 \
    	,	max(d18) as d18 \
    	,	max(d19) as d19 \
    	,	max(d20) as d20 \
    	,	max(d21) as d21 \
    	,	max(d22) as d22 \
    	,	max(d23) as d23 \
    	,	max(d24) as d24 \
    	,	max(d25) as d25 \
    	,	max(d26) as d26 \
    	,	max(d27) as d27 \
    	,	max(d28) as d28 \
    	,	max(d29) as d29 \
    	,	max(d30) as d30 \
    	,	max(d31) as d31 \
    from countera \
    GROUP BY ampm_gubun,gubun
    
# 노선배차상태
 mtr.query.filter_getRouteArrangeStatus= \
 	SELECT 	a.ROUTE_NM,b.STATUS,b.LAST_CHG_USER,b.LAST_CHG_DATE \
	FROM 	TBL_ROUTEINFO a left outer join TBM_MONTH_ARRANGE_STATUS b \
		on	a.company_no = b.company_no \
		and a.route_nm   = b.route_nm \
	    AND b.BASE_YM = '@baseYm' \
		AND	b.ROUTE_NM like '@routeNm' || '%' \
	WHERE 	a.company_no = '@companyNo' \
	ORDER BY 1

#근태현황조회  
 mtr.query.filter_selectEmpNmList= \
	SELECT	DISTINCT(b.EMP_NM) || '/' || b.ROUTE_NM ||  '/' || b.sp_gb || '/' || b.car_regno as emp_info ,b.EMP_NM,b.route_nm,b.sp_gb \
	FROM	TBL_DRIVERINFO b \
	WHERE	b.company_no = '100' \
	AND     b.emp_nm like ('@empNm' || '%') \
	order by b.route_nm desc,b.sp_gb desc,b.EMP_NM


#근태현황조회  
 mtr.query.filter_selectAttendanceInfo= \
	SELECT a.* ,a.start_date||a.emp_nm as key,rownum as id \
		,	b.ROUTE_NM ,b.SP_GB ,b.CAR_REGNO \
		,	b.EMP_NM || '/' || b.ROUTE_NM ||  '/' || b.sp_gb || '/' || b.car_regno as emp_info \
	FROM TBM_EMPLOYEE_VACATION_INFO a LEFT OUTER join TBL_DRIVERINFO b \
		on 	a.COMPANY_NO  	= b.COMPANY_NO \
		AND a.EMP_NM 		= b.EMP_NM \
	where 	a.company_no = '@companyNo' \
    AND 	a.start_date   between '@fromDate' and '@toDate' \
	and 	a.emp_nm like '@empNm%' \
	AND 	a.attendance_Type  = decode ('@attendanceType','all',a.attendance_Type,'@attendanceType') \
	order by a.start_date,a.emp_nm,a.attendance_type

#SP 기사의 타노선 배차정보  
 mtr.query.filter_sp_otherAllocateInfo= \
	SELECT  b.ROUTE_NM,b.CAR_REGNO \
	 FROM 	TBL_MONTH_ARRANGE_DETAIL b \
	where 	b.company_no = '@companyNo' \
        AND b.BASE_YM = '@baseYm' \
  	 	and b.DISPATCH_SEQ = 6 \
  	 	and b.INIT_SEQ = 0 \
	 	AND b.CAR_REGNO NOT LIKE  'SP%' \
	 	AND b.ROUTE_NM <> '@routeNm' \
	 	AND b.d@checkDay = '@dayValue' || '-' 
	 	
#당월배차_전월근무패턴(운전자정보상세)
 mtr.query.filter_TBM_DRIVERINFO_DETAIL= \
	SELECT  'N' as bit,CAR_REGNO ,EMP_NM ,prev_daily_seq ,PREV_WORK_PATTERN ,ampm_gubun, off_group, CAR_REGNO||EMP_NM as key \
	FROM TBM_DRIVERINFO_DETAIL \
    where   company_no = '@companyNo' \
	AND 	route_nm = '@routeNm' \
	AND     BASE_YM = '@baseYm'
	 
#사원정보
 mtr.query.filter_TBL_EMPLOYEEINFO= \
    select   ROWNUM AS no,a.* \
    from    TBL_employeeInfo a \
    where   a.company_no = '@companyNo' \
    order by a.emp_no
    
#사원정보
 mtr.query.filter_getEmployeeList= \
    select   a.emp_no,a.emp_nm,nvl(b.route_nm,'-') as route_nm, nvl(b.WORK_GROUP,'-') as work_group \
    from    TBL_employeeInfo a left outer join TBL_DRIVERINFO b on a.company_no = b.company_no and a.emp_nm = b.emp_nm \
    where   a.company_no = '@companyNo' \
    and	    b.sp_gb = decode('@filterText','ALL',b.sp_gb,'@filterText') \
    order by a.emp_nm
    
        
#차량정보
 mtr.query.filter_TBL_CARINFO= \
    select   ROWNUM AS no,a.* \
    from    TBL_carInfo a \
    where   a.company_no = '@companyNo' \
    order by a.car_regno

#교통사고정보
 mtr.query.filter_TBM_ACCIDENT_INFO= \
    select   ROWNUM AS no,'N' as bit,a.* \
    from    TBM_ACCIDENT_INFO a \
    where   a.company_no = '@companyNo' \
    and     a.acc_date between '@fromDate-01' and '@toDate-31' \
	AND   	a.acc_gb like '@codeType1' || '%' \
	AND   	a.acc_kind like '@codeType2' || '%' \
	AND   	a.gapi_gb like '@codeType3' || '%' \
    order by a.acc_date,acc_time
    
#인사카드-교통사고정보-운전자별
 mtr.query.filter_TBM_ACCIDENT_INFO_empNm= \
    select   ROWNUM AS no,a.* \
    from    TBM_ACCIDENT_INFO a \
    where   a.company_no = '@companyNo' \
    and     a.emp_nm = '@empNm' \
    and     a.acc_date between '@fromDate-01' and '@toDate-31' \
    order by a.acc_date desc,a.acc_time desc    

#인사카드-행정민원-운전자별
 mtr.query.filter_TBL_PUBLIC_COMPLAINT_INFO_empNm= \
    select   ROWNUM AS no,a.* \
    from    TBL_PUBLIC_COMPLAINT_INFO a \
    where   a.company_no = '@companyNo' \
    and     a.emp_nm = '@empNm' \
    and     a.comp_date between '@fromDate-01' and '@toDate-31' \
    order by a.comp_date desc,a.seq desc    

#인사카드-근태정보-운전자별
 mtr.query.filter_TBM_EMP_WORKING_LOG_empNm= \
    select   ROWNUM AS no,a.* \
    from    TBM_EMP_WORKING_LOG a \
    where   a.company_no = '@companyNo' \
    and     a.emp_nm = '@empNm' \
    and     a.work_date between '@fromDate-01' and '@toDate-31' \
    order by a.work_date desc,a.work_time desc    

#인사카드-휴가
 mtr.query.filter_TBM_EMPLOYEE_VACATION_INFO_emp= \
    select   ROWNUM AS no,a.* \
    from    TBM_EMPLOYEE_VACATION_INFO a \
    where   a.company_no = '@companyNo' \
    and     a.emp_nm = '@empNm' \
    and     a.start_date between '@fromDate-01' and '@toDate-31' \
    and		a.delete_yn = 'N' \
    order by a.start_date desc    


#운전자정보
 mtr.query.filter_TBL_DRIVERINFO= \
    select   ROWNUM AS no,a.* \
    from    TBL_DRIVERINFO a \
    where   a.company_no = '@companyNo' \
    order by a.emp_no

#file정보
 mtr.query.filter_TBL_FILE_INFO= \
    select   a.*,'' as excelFile,'N' as bit \
    from    TBL_FILE_INFO a \
    where   a.company_no = '@companyNo' \
    and     a.orgnm like 'templete%' \
    order by a.file_gb,a.file_id
    
#노선정보
 mtr.query.filter_TBL_ROUTEINFO= \
    select   ROWNUM AS no,a.* \
    from    TBL_ROUTEINFO a \
    where   a.company_no = '@companyNo' \
    order by a.lno
    
#운행횟수상세
 mtr.query.filter_TBL_DRIVING_RECORD= \
    select   ROWNUM AS no,a.* \
    from    TBL_DRIVING_RECORD a \
    where   a.company_no = '@companyNo' \
    and     a.base_ym = '@baseYm' \
    order by a.work_date   ,a.route_nm,a.start_time

#isc운전자정보
 mtr.query.filter_TBL_ISC_DRIVER_INFO= \
    select   ROWNUM AS no,a.* \
    from    TBL_ISC_DRIVER_INFO a \
    where   a.company_no = '@companyNo' \
    order by a.emp_nm
    
#노선공통정보-배차정시성대상회차
 mtr.query.filter_TBM_ROUTE_COMMON_INFO= \
    select   'N' as bit, a.* \
    from    TBM_ROUTE_COMMON_INFO a \
    where   a.company_no = '@companyNo' \
    and		a.code = '@filterText' \
    order by a.route_nm    

    
#배차정시성조회
 mtr.query.filter_TBL_ARRANGE_PUNCTUALITY_INFO_DETAIL= \
	select  a.* \
	from    TBL_ARRANGE_PUNCTUALITY_ANALIZE a \
	where   a.company_no = '@companyNo' \
	AND 	a.BASE_YMD =  '@baseYmd' \
	AND 	a.ROUTE_NM = decode('@routeNm','-회사-',a.ROUTE_NM,'@routeNm') \
	ORDER BY col002,col003

#사용안함
 mtr.query.filter_TBL_ARRANGE_PUNCTUALITY_INFO_DETAIL9= \
	select  1 AS seq,'-' TERM, '-' TERM_85,'-' TERM_125,'0' as TERM_PAST_CNT,'0' as TERM_LATE_CNT, '0' as TERM_WIBAN_CNT,'0' as TOTAL_STATION_CNT,a.* \
	from    TBL_ARRANGE_PUNCTUALITY_INFO a \
	where   a.company_no = '@companyNo' \
	AND 	a.BASE_YMD =  '@baseYmd' \
	AND 	a.ROUTE_NM = decode('@routeNm','-회사-',a.ROUTE_NM,'@routeNm') \
	and		a.col000 = '버스ID' \
	union \
	select  2 AS seq, a.TERM,a.TERM_85,a.TERM_125,a.TERM_PAST_CNT,a.TERM_LATE_CNT,a.TERM_WIBAN_CNT,a.TOTAL_STATION_CNT,b.* \
	from    TBL_ARRANGE_PUNCTUALITY_ANALIZE a \
	JOIN TBL_ARRANGE_PUNCTUALITY_INFO b ON a.COMPANY_NO =b.COMPANY_NO AND a.BASE_YMD =b.BASE_YMD AND a.ROUTE_NM =b.ROUTE_NM AND a.COL000 =b.COL000 AND a.COL002 =b.COL002 \
	where   a.company_no = '@companyNo' \
	AND 	a.BASE_YMD =  '@baseYmd' \
	AND 	a.ROUTE_NM = decode('@routeNm','-회사-',a.ROUTE_NM,'@routeNm') \
	ORDER BY 1,col002,col003
    
#배차정시성조회 자료검토용
 mtr.query.filter_TBL_ARRANGE_PUNCTUALITY_INFO_BEFORE= \
    select   1 seq,'-' as emp_nm, 'a' as ampm_gb,a.* \
    from    TBL_arrange_punctuality_info a \
    where   a.company_no = '@companyNo' \
	AND 	route_nm = '@routeNm' \
	AND     BASE_YMD = '@baseYmd' \
	and		col000 = '버스ID' \
	union \
 	SELECT 2 seq ,nvl(k.col200,'-') as emp_nm \
 		,k.* \
	FROM ( \
	    select \
				CASE WHEN (',' || b.am_seq_array || ',' LIKE '%,' || a.col002 ||',%') THEN 'a' \
						ELSE 'p' END ampm_gb \
			,	a.* \
	    from    TBL_arrange_punctuality_info a JOIN TBM_ROUTE_COMMON_INFO b ON a.COMPANY_NO = b.COMPANY_NO AND a.ROUTE_NM = b.ROUTE_NM AND b.CODE ='배차정시성대상회차' \
	    where   a.company_no = '@companyNo' \
		AND 	a.route_nm = '@routeNm' \
		AND     a.BASE_YMD = '@baseYmd' \
		and		a.col000 <> '버스ID' \
		AND     ( (',' || b.am_seq_array || ',' LIKE '%,' || a.col002 ||',%') \
		         OR (',' || b.pm_seq_array || ',' LIKE '%,' || a.col002 ||',%')) \
	) k \
    order by seq,col003


#배차정시성조회 자료검토용
 mtr.query.filter_TBL_ARRANGE_PUNCTUALITY_INFO_BEFORE_OLD= \
 WITH daily_arrange as \
 ( \
	SELECT \
		a.CAR_REGNO , \
		a.EMP_NM , \
		'' AS value, \
		REGEXP_REPLACE(a.@checkDay, '[*0-9@]', '') AS ampm, \
		CONVERT(REGEXP_REPLACE(a.@checkDay, '[*ap@]', ''),	int) AS seq \
	FROM \
		TBL_MONTH_ARRANGE_DETAIL a \
	WHERE \
		a.company_no = '@companyNo' \
		AND a.route_nm = '@routeNm' \
		AND a.BASE_Ym = '@baseYm' \
		AND a.CAR_REGNO NOT LIKE 'SP%' \
		AND a.@checkDay NOT LIKE '%*%' \
		AND a.@checkDay NOT LIKE '%@%' \
		AND a.DISPATCH_SEQ = 6 \
		AND a.INIT_SEQ = 0 \
 UNION ALL \
	SELECT \
		a.CAR_REGNO , \
		b.EMP_NM , \
		decode(b.EMP_NM, NULL, '', 'SP') AS value, \
		REGEXP_REPLACE(a.@checkDay, '[*0-9@-]', '') AS ampm, \
		CONVERT(REGEXP_REPLACE(a.@checkDay, '[*ap@-]', ''),int) AS seq \
	FROM \
		TBL_MONTH_ARRANGE_DETAIL a \
	LEFT OUTER JOIN TBL_MONTH_ARRANGE_DETAIL b ON \
		a.COMPANY_NO = b.COMPANY_NO \
		AND a.ROUTE_NM = b.ROUTE_NM \
		AND a.BASE_YM = b.BASE_YM \
		AND a.DISPATCH_SEQ = b.DISPATCH_SEQ \
		AND a.INIT_SEQ = b.INIT_SEQ \
		AND b.CAR_REGNO LIKE 'SP%' \
		AND b.@checkDay <> '' \
		AND a.@checkDay LIKE b.@checkDay || '%' \
	WHERE \
		a.company_no = '@companyNo' \
		AND a.route_nm = '@routeNm' \
		AND a.BASE_Ym = '@baseYm' \
		AND a.CAR_REGNO NOT LIKE 'SP%' \
		AND (a.@checkDay LIKE '%*%'			OR a.@checkDay LIKE '%@%') \
		AND a.DISPATCH_SEQ = 6  \
		AND a.INIT_SEQ = 0 \
 ) \
    select   1 seq,'-' as emp_nm, 'a' as ampm_gb,a.* \
    from    TBL_arrange_punctuality_info a \
    where   a.company_no = '@companyNo' \
	AND 	route_nm = '@routeNm' \
	AND     BASE_YMD = '@baseYmd' \
	and		col000 = '버스ID' \
	union \
 	SELECT 2 seq ,nvl(d.emp_nm,'-') as emp_nm \
 		,k.* \
	FROM ( \
	    select \
				CASE WHEN (',' || b.am_seq_array || ',' LIKE '%,' || a.col002 ||',%') THEN 'a' \
						ELSE 'p' END ampm_gb \
			,	a.* \
	    from    TBL_arrange_punctuality_info a JOIN TBM_ROUTE_COMMON_INFO b ON a.COMPANY_NO = b.COMPANY_NO AND a.ROUTE_NM = b.ROUTE_NM AND b.CODE ='배차정시성대상회차' \
	    where   a.company_no = '@companyNo' \
		AND 	a.route_nm = '@routeNm' \
		AND     a.BASE_YMD = '@baseYmd' \
		and		a.col000 <> '버스ID' \
		AND     ( (',' || b.am_seq_array || ',' LIKE '%,' || a.col002 ||',%') \
		         OR (',' || b.pm_seq_array || ',' LIKE '%,' || a.col002 ||',%')) \
	) k left outer join daily_arrange d \
	on k.col001 = d.car_regno \
	AND 	k.ampm_gb = d.ampm		\
    order by seq,col003


mtr.query.filter_TBL_ARRANGE_PUNCTUALITY_INFO= \
    select   1 seq, a.* \
    from    TBL_arrange_punctuality_info a \
    where   a.company_no = '@companyNo' \
	AND 	route_nm = '@routeNm' \
	AND     BASE_YMD = '@baseYmd' \
	and		col000 = '버스ID' \
	union \
    select  2 seq, a.* \
    from    TBL_arrange_punctuality_info a \
    where   a.company_no = '@companyNo' \
	AND 	a.route_nm = '@routeNm' \
	AND     a.BASE_YMD = '@baseYmd' \
	and		a.col000 <> '버스ID' \
    order by seq,col003
    
mtr.query.filter_TBL_ARRANGE_PUNCTUALITY_ANALIZE_emp= \
    select  a.* \
    from    TBL_ARRANGE_PUNCTUALITY_ANALIZE a \
    where   a.company_no = '@companyNo' \
	AND     a.BASE_YMD BETWEEN '@fromDate-01' AND '@toDate-31'  \
	and		a.emp_nm = '@empNm' \
    ORDER BY a.base_ymd DESC,a.col003 desc
    
mtr.query.filter_TBL_ARRANGE_PUNCTUALITY_INFO_OLD= \
    select   1 seq,'' as emp_nm, a.* \
    from    TBL_arrange_punctuality_info a \
    where   a.company_no = '@companyNo' \
	AND 	route_nm = '@routeNm' \
	AND     BASE_YMD = '@baseYmd' \
	and		col000 = '버스ID' \
	union \
    select  2 seq, a.* \
    from    TBL_arrange_punctuality_info a JOIN TBM_ROUTE_COMMON_INFO b ON a.COMPANY_NO = b.COMPANY_NO AND a.ROUTE_NM = b.ROUTE_NM AND b.CODE ='배차정시성대상회차' \
    where   a.company_no = '@companyNo' \
	AND 	a.route_nm = '@routeNm' \
	AND     a.BASE_YMD = '@baseYmd' \
	and		a.col000 <> '버스ID' \
	and     a.col = 'false' \
	AND     ( (b.CODE_VALUE1 LIKE a.col002 ||',%') or  (b.CODE_VALUE1 LIKE '%,' || a.col002 ) or (b.CODE_VALUE1 LIKE a.col002 ) \
	         OR (b.CODE_VALUE2 LIKE a.col002 ||',%') or  (b.CODE_VALUE2 LIKE '%,' || a.col002 ) or (b.CODE_VALUE2 LIKE a.col002 )) \
    order by seq,col003

#위험운전통계
 mtr.query.filter_TBL_DANGER_DRIVING_INFO= \
    select   ROWNUM AS no,a.* \
    from    TBL_DANGER_DRIVING_INFO a \
    where   a.company_no = '@companyNo' \
	AND     a.BASE_YM   = '@baseYm' \
    order by a.emp_nm

#행정민원
 mtr.query.filter_TBL_PUBLIC_COMPLAINT_INFO= \
    select   ROWNUM AS no,a.* \
    from    TBL_PUBLIC_COMPLAINT_INFO a \
    where   a.company_no = '@companyNo' \
	AND     a.COMP_DATE between  '@fromDate-01' and '@toDate-31'\
    order by a.COMP_DATE, a.SEQ



#근태노무조회
 mtr.query.filter_TBM_EMP_WORKING_LOG= \
    select   ROWNUM AS no,'N' as bit, a.* \
    from    TBM_EMP_WORKING_LOG a \
    where   a.company_no = '@companyNo' \
	AND   	a.work_date between '@fromDate' and '@toDate' \
	AND   	a.code_type1 like '@codeType1' || '%' \
	AND   	a.code_type2 like '@codeType2' || '%' \
	AND   	a.code_type3 like '@codeType3' || '%' \
    order by a.work_date,a.work_time
    
#공통코드_민원
 mtr.query.filter_TBM_COMMON_CODE_INFO_complaints= \
	SELECT  k.NO,'N' as bit, max(k.type1) as code_type1,max(k.type2) as code_type2,max(k.type3) as code_type3 \
	FROM ( \
		SELECT ROWNUM AS no,code_id AS type1,'' AS type2,	'' AS type3 \
		FROM TBM_COMMON_CODE_INFO	WHERE COMPANY_NO  ='@companyNo' AND code_gb ='민원대분류' \
		UNION \
		SELECT ROWNUM AS no,'',	code_id,'' \
		FROM TBM_COMMON_CODE_INFO WHERE COMPANY_NO  = '@companyNo'	AND code_gb ='민원중분류' \
		UNION \
		SELECT ROWNUM AS no, '','',code_id \
		FROM TBM_COMMON_CODE_INFO	WHERE COMPANY_NO  = '@companyNo' AND code_gb ='민원소분류'\ 
	) k \
	GROUP BY k.no


#공통코드_인사평가배점
 mtr.query.filter_TBM_COMMON_CODE_INFO_point= \
	SELECT 	'N' as bit, a.CODE_GB, CODE_ID, CODE_NM ,MEMO, CODE_VALUE, CODE_MIN, CODE_MAX, USE_YN \
	FROM 	TBM_COMMON_CODE_INFO a \
	WHERE 	a.COMPANY_NO  = '@companyNo' \
	AND 	a.CODE_GB = '인사평가배점'

#SP기사정보
 mtr.query.filter_TBM_DRIVERINFO_SP= \
	SELECT decode(ROUTE_NM,'@routeNm','0'||ROUTE_NM,'1'||ROUTE_NM)   AS ord,ROUTE_NM ,EMP_NM ,BIRTH_YMD ,ENTER_DATE, HOBONG \
	FROM TBL_DRIVERINFO td \
	WHERE COMPANY_NO ='@companyNo' \
	AND SP_GB  = 'SP' \
	AND ACTIVE_STATUS ='재직' \
	ORDER BY 1,BIRTH_YMD  

    
#노선별 요일별 근무순번 정보
 mtr.query.filter_TBM_ROUTE_WEEKSEQ_INFO= \
	SELECT 	WEEK_GB \
		,	decode(SUBSTR(WEEK_GB,1,1),'공','공휴일','토','토요일','평','평일') as WEEK_GB1 \
		,	decode(SUBSTR(WEEK_GB,2,1),'공','공휴일','토','토요일','평','평일') as WEEK_GB2 \
		, 	NEXT_WORK_INTERVAL \
		, 	'N' as bit \
		,	route_nm \
	FROM 	TBM_ROUTE_WEEKSEQ_INFO  \
	WHERE 	COMPANY_NO ='@companyNo' \
	AND 	route_nm = '@routeNm' \
	ORDER BY 1 
    

#휴가정보
 mtr.query.filter_TBM_EMPLOYEE_VACATION_INFO= \
	SELECT  substr(b.start_date,6) as start_date \ 
			,	b.emp_nm \
			,	b.attendance_type \
			, 	b.memo \
	FROM TBL_DRIVERINFO a,TBM_EMPLOYEE_VACATION_INFO b \
	WHERE 	a.COMPANY_NO ='@companyNo' \
	AND 	a.route_nm = '@routeNm' \
	AND 	a.COMPANY_NO  = b.COMPANY_NO \
	AND 	a.EMP_NM = b.EMP_NM \
	AND     b.delete_yn = 'N' \
	AND 	b.START_DATE LIKE '@baseYm' || '%' \
	ORDER BY 1,2 
    

    
#배차정시성 분석을 위한 설정
 mtr.query.filter_getRouteCommonInfo= \
    select   a.am_seq_array, a.pm_seq_array, wiban_gijun,wiban_min_value,wiban_max_value \
    from    TBM_ROUTE_COMMON_INFO a \
    where   a.company_no = '@companyNo' \
	AND     a.ROUTE_NM   = '@routeNm' \
	AND		a.CODE =  '배차정시성대상회차' 
    
#배차정시성 분석결과
 mtr.query.filter_TBL_ARRANGE_PUNCTUALITY_ANALIZE= \
    select   1 as seq,1 as temp,a.* \
    from    TBL_ARRANGE_PUNCTUALITY_ANALIZE a \
    where   a.company_no = '@companyNo' \
	AND     a.ROUTE_NM   = '@routeNm' \
	AND		a.BASE_YMD   = '@baseYmd' order by a.col002
   
        
# 배차 상세
# 휴가는 @로 표시하며
# 최종적으로 '-':대차, '*:휴무', '@:휴가' 가 아닌경우 '@'를 붙혀 조회한다. 
 mtr.h2.BUS_monthArrangeDetail= \
 SELECT b.CAR_REGNO,b.emp_nm ,0 counta,0 countp, 0 AS tot_work_date \
    ,b.D1  \
	,b.D2  \
	,b.D3  \
	,b.D4  \
	,b.D5  \
	,b.D6  \
	,b.D7  \
	,b.D8  \
	,b.D9  \
	,b.D10 \
	,b.D11 \
	,b.D12 \
	,b.D13 \
	,b.D14 \
	,b.D15 \
	,b.D16 \
	,b.D17 \
	,b.D18 \
	,b.D19 \
	,b.D20 \
	,b.D21 \
	,b.D22 \
	,b.D23 \
	,b.D24 \
	,b.D25 \
	,b.D26 \
	,b.D27 \
	,b.D28 \
	,b.D29 \
	,b.D30 \
	,b.D31 \
	,'N' AS bit \
 FROM 	TBL_MONTH_ARRANGE_DETAIL b \
 WHERE 	b.company_no = '@companyNo' \
 AND 	b.route_nm = '@routeNm' \
 AND    b.init_seq = @initSeq \
 AND    b.BASE_YM = '@baseYm' \
 AND    b.DISPATCH_SEQ = 6 \
 AND    b.CAR_REGNO not like 'SP%' \
 order by b.dispatch_seq,b.CAR_REGNO ,b.ampm_gubun,b.prev_daily_seq
		
# 배차상세 요일		
 mtr.h2.BUS_monthArrangeDetail2= \
 SELECT '[@routeNm] @baseYm월' as CAR_REGNO,b.emp_nm,0 counta,0 countp,0 AS tot_work_date \
	, b.D1    , b.D2    , b.D3    , b.D4    , b.D5    , b.D6    , b.D7    , b.D8    , b.D9    , b.D10 \
    , b.D11    , b.D12    , b.D13    , b.D14    , b.D15    , b.D16    , b.D17    , b.D18    , b.D19    , b.D20 \
    , b.D21    , b.D22    , b.D23    , b.D24    , b.D25    , b.D26    , b.D27    , b.D28    , b.D29    , b.D30 \
    , b.D31 ,'N' as bit \
 FROM 	TBL_MONTH_ARRANGE_DETAIL b \
 WHERE 	b.company_no = '@companyNo' \
 AND 	b.route_nm = '@routeNm' \
 AND    b.init_seq = @initSeq \
 AND    b.BASE_YM = '@baseYm' \
 AND    b.DISPATCH_SEQ = 1
 
# sp배차정보(사용안함)
#     , DAY(DATEADD(DAY,-1,DATEADD(MONTH ,1,date'@baseYm01') ) ) \
 mtr.h2.BUS_monthArrangeSP= \
 SELECT b.CAR_REGNO,b.emp_nm \
    , LENGTH (REGEXP_REPLACE(b.D1||b.D2||b.D3||b.D4||b.D5||b.D6||b.D7||b.D8||b.D9||b.D10||b.D11||b.D12||b.D13||b.D14||b.D15||b.D16||b.D17||b.D18||b.D19||b.D20||b.D21||b.D22||b.D23||b.D24||b.D25||b.D26||b.D27||b.D28||b.D29||b.D30||b.D31,'[0-9# ]','') ) AS tot_work_date \
	, b.D1    , b.D2    , b.D3    , b.D4    , b.D5    , b.D6    , b.D7    , b.D8    , b.D9    , b.D10 \
    , b.D11    , b.D12    , b.D13    , b.D14    , b.D15    , b.D16    , b.D17    , b.D18    , b.D19    , b.D20 \
    , b.D21    , b.D22    , b.D23    , b.D24    , b.D25    , b.D26    , b.D27    , b.D28    , b.D29    , b.D30 \
    , b.D31 ,'N' as bit \
 FROM 	TBL_MONTH_ARRANGE_DETAIL b \
 WHERE 	b.company_no = '@companyNo' \
 AND 	b.route_nm = '@routeNm' \
 AND    b.init_seq = @initSeq \
 AND    b.BASE_YM = '@baseYm' \
 AND    b.DISPATCH_SEQ = 6 \
 AND    b.CAR_REGNO like 'SP%' \
 order by b.prev_daily_seq
 
# 타노선 SP추가후 조회   
#		/*,	LENGTH (REGEXP_REPLACE(b.D1||b.D2||b.D3||b.D4||b.D5||b.D6||b.D7||b.D8||b.D9||b.D10||b.D11||b.D12||b.D13||b.D14||b.D15||b.D16||b.D17||b.D18||b.D19||b.D20||b.D21||b.D22||b.D23||b.D24||b.D25||b.D26||b.D27||b.D28||b.D29||b.D30||b.D31,'[0-9# ]','') ) AS tot_work_date */ \
 mtr.h2.BUS_monthArrangeSP_other= \
	 WITH sp_maxinfo AS ( \
		SELECT  b.CAR_REGNO,b.EMP_NM \
		       ,nvl(max(CASE WHEN nvl(b.D1 ,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D1   ELSE '#' || b.D1  end),' ') as D1 \
		       ,nvl(max(CASE WHEN nvl(b.D2 ,'') = '' THEN '' WHEN b.route_nm = '@routeNm' tHEN b.D2   ELSE '#' || b.D2  end),' ') as D2 \
		       ,nvl(max(CASE WHEN nvl(b.D3 ,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D3   ELSE '#' || b.D3   end),' ') as D3 \
		       ,nvl(max(CASE WHEN nvl(b.D4 ,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D4   ELSE '#' || b.D4   end),' ') as D4 \
		       ,nvl(max(CASE WHEN nvl(b.D5 ,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D5   ELSE '#' || b.D5   end),' ') as D5 \
		       ,nvl(max(CASE WHEN nvl(b.D6 ,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D6   ELSE '#' || b.D6   end),' ') as D6 \
		       ,nvl(max(CASE WHEN nvl(b.D7 ,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D7   ELSE '#' || b.D7   end),' ') as D7 \
		       ,nvl(max(CASE WHEN nvl(b.D8 ,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D8   ELSE '#' || b.D8   end),' ') as D8 \
		       ,nvl(max(CASE WHEN nvl(b.D9 ,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D9   ELSE '#' || b.D9   end),' ') as D9 \
		       ,nvl(max(CASE WHEN nvl(b.D10,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D10  ELSE '#' || b.D10  end),' ') as D10 \
		       ,nvl(max(CASE WHEN nvl(b.D11,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D11  ELSE '#' || b.D11  end),' ') as D11 \
		       ,nvl(max(CASE WHEN nvl(b.D12,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D12  ELSE '#' || b.D12  end),' ') as D12 \
		       ,nvl(max(CASE WHEN nvl(b.D13,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D13  ELSE '#' || b.D13  end),' ') as D13 \
		       ,nvl(max(CASE WHEN nvl(b.D14,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D14  ELSE '#' || b.D14  end),' ') as D14 \
		       ,nvl(max(CASE WHEN nvl(b.D15,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D15  ELSE '#' || b.D15  end),' ') as D15 \
		       ,nvl(max(CASE WHEN nvl(b.D16,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D16  ELSE '#' || b.D16  end),' ') as D16 \
		       ,nvl(max(CASE WHEN nvl(b.D17,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D17  ELSE '#' || b.D17  end),' ') as D17 \
		       ,nvl(max(CASE WHEN nvl(b.D18,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D18  ELSE '#' || b.D18  end),' ') as D18 \
		       ,nvl(max(CASE WHEN nvl(b.D19,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D19  ELSE '#' || b.D19  end),' ') as D19 \
		       ,nvl(max(CASE WHEN nvl(b.D20,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D20  ELSE '#' || b.D20  end),' ') as D20 \
		       ,nvl(max(CASE WHEN nvl(b.D21,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D21  ELSE '#' || b.D21  end),' ') as D21 \
		       ,nvl(max(CASE WHEN nvl(b.D22,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D22  ELSE '#' || b.D22  end),' ') as D22 \
		       ,nvl(max(CASE WHEN nvl(b.D23,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D23  ELSE '#' || b.D23  end),' ') as D23 \
		       ,nvl(max(CASE WHEN nvl(b.D24,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D24  ELSE '#' || b.D24  end),' ') as D24 \
		       ,nvl(max(CASE WHEN nvl(b.D25,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D25  ELSE '#' || b.D25  end),' ') as D25 \
		       ,nvl(max(CASE WHEN nvl(b.D26,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D26  ELSE '#' || b.D26  end),' ') as D26 \
		       ,nvl(max(CASE WHEN nvl(b.D27,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D27  ELSE '#' || b.D27  end),' ') as D27 \
		       ,nvl(max(CASE WHEN nvl(b.D28,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D28  ELSE '#' || b.D28  end),' ') as D28 \
		       ,nvl(max(CASE WHEN nvl(b.D29,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D29  ELSE '#' || b.D29  end),' ') as D29 \
		       ,nvl(max(CASE WHEN nvl(b.D30,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D30  ELSE '#' || b.D30  end),' ') as D30 \
		       ,nvl(max(CASE WHEN nvl(b.D31,'') = '' THEN '' WHEN b.route_nm = '@routeNm' THEN b.D31  ELSE '#' || b.D31  end),' ') as D31 \
			 FROM 	TBL_MONTH_ARRANGE_DETAIL b \
			where 	b.company_no = '@companyNo' \
					AND b.BASE_YM = '@baseYm' \
			  	 	and b.DISPATCH_SEQ = 6 \
			  	 	and b.init_seq = @initSeq \
				 	AND b.CAR_REGNO LIKE  'SP%' \
				 	GROUP BY b.CAR_REGNO,b.emp_nm \
	) \
	SELECT b.*,'N' as bit ,0 counta, 0 countp \
		,	LENGTH (REGEXP_REPLACE(b.D1||b.D2||b.D3||b.D4||b.D5||b.D6||b.D7||b.D8||b.D9||b.D10||b.D11||b.D12||b.D13||b.D14||b.D15||b.D16||b.D17||b.D18||b.D19||b.D20||b.D21||b.D22||b.D23||b.D24||b.D25||b.D26||b.D27||b.D28||b.D29||b.D30||b.D31,'[0-9# ]','') ) AS tot_work_date \
	FROM ( \
		SELECT  a.prev_daily_seq,b.* \
				FROM 	TBL_MONTH_ARRANGE_DETAIL a LEFT OUTER JOIN sp_maxinfo b \
					ON	a.emp_nm = b.EMP_NM \
				   AND  a.car_regno = b.CAR_REGNO \
				where 	a.company_no = '@companyNo' \
					AND a.BASE_YM = '@baseYm' \
			  	 	and a.DISPATCH_SEQ = 6 \
			  	 	and a.init_seq = @initSeq \
				 	AND a.CAR_REGNO LIKE  'SP%' \
				 	AND a.emp_nm = decode('@empNm','',a.emp_nm,'@empNm') \
				 	AND a.route_nm = '@routeNm' \
	) b \
	ORDER BY b.prev_daily_seq


# 노선정보
 mtr.h2.BUS_getRouteNmInfo= SELECT ROUTE_NM  FROM TBL_ROUTEINFO a where 	a.company_no = '@companyNo' ORDER BY 1
# 회사정보
 mtr.h2.BUS_getCompanyInfo= SELECT company_no,company_nm  FROM TBL_COMPANYINFO where use_yn = 'Y' ORDER BY 1

# 차량정보
 mtr.h2.BUS_getCarNoInfo=  SELECT DISTINCT(car_no) FROM TBL_CARINFO a where 	a.company_no = '@companyNo' order by 1
 
# 배차 기본
 mtr.h2.BUS_monthArrangeBasic= \
 WITH carInfo AS ( \
	SELECT '감차후 총 차량댓수' as CAR_REGNO,'' AS AMPM_GUBUN ,b.emp_nm,0 counta,0 countp,0 AS tot_work_date \
		, b.D1    , b.D2    , b.D3    , b.D4    , b.D5    , b.D6    , b.D7    , b.D8    , b.D9    , b.D10 \
	    , b.D11    , b.D12    , b.D13    , b.D14    , b.D15    , b.D16    , b.D17    , b.D18    , b.D19    , b.D20 \
	    , b.D21    , b.D22    , b.D23    , b.D24    , b.D25    , b.D26    , b.D27    , b.D28    , b.D29    , b.D30 \
	    , b.D31 \
	 FROM 	TBL_MONTH_ARRANGE_BASIC b \
	 WHERE 	b.company_no = '@companyNo' \
	 AND 	b.route_nm = '@routeNm' \
	 AND    b.init_seq = @initSeq \
	 AND    b.BASE_YM = '@baseYm' \
	 AND    b.DISPATCH_SEQ = 2  \
	 AND	b.CAR_REGNO  = '-' \
), allocateInfo AS ( \
	SELECT  decode(AMPM_GUBUN,'p','오전','오후') || ' 배정 건수' AS CAR_REGNO,ampm_gubun,'-' emp_nm,0 counta,0 countp,0 AS tot_work_date \
		,0 D1 \
		,0 D2 \
		,0 D3 \
		,0 D4 \
		,0 D5 \
		,0 D6 \
		,0 D7 \
		,0 D8 \
		,0 D9 \
		,0 D10 \
		,0 D11 \
		,0 D12 \
		,0 D13 \
		,0 D14 \
		,0 D15 \
		,0 D16 \
		,0 D17 \
		,0 D18 \
		,0 D19 \
		,0 D20 \
		,0 D21 \
		,0 D22 \
		,0 D23 \
		,0 D24 \
		,0 D25 \
		,0 D26 \
		,0 D27 \
		,0 D28 \
		,0 d29 \
		,0 d30 \
		,0 d31 \
	 FROM 	TBL_MONTH_ARRANGE_DETAIL b \
	 WHERE 	b.company_no = '@companyNo' \
	 AND 	b.route_nm = '@routeNm' \
	 AND    b.init_seq = @initSeq \
	 AND    b.BASE_YM = '@baseYm' \
	 AND    b.DISPATCH_SEQ = 6  \
	 AND    b.PREV_DAILY_SEQ = 1 \
	 AND    b.AMPM_GUBUN IN ('a','p') \
) \
 SELECT * FROM carInfo \
 union all \
  SELECT '감차후 총 운행횟수' as CAR_REGNO,' ' AMPM_GUBUN ,b.emp_nm,0 counta,0 countp,0 AS tot_work_date \
	, b.D1 *2   , b.D2 *2    , b.D3  *2   , b.D4 *2    , b.D5 *2    , b.D6 *2    , b.D7 *2    , b.D8 *2    , b.D9 *2    , b.D10 *2 \
    , b.D11 *2    , b.D12 *2    , b.D13 *2    , b.D14 *2    , b.D15 *2    , b.D16 *2    , b.D17 *2    , b.D18 *2    , b.D19 *2    , b.D20 *2 \
    , b.D21 *2    , b.D22 *2    , b.D23 *2    , b.D24 *2    , b.D25 *2    , b.D26 *2    , b.D27 *2    , b.D28 *2    , b.D29 *2    , b.D30 *2 \
    , b.D31 *2 \
 FROM 	carInfo b \
 union all \
 SELECT  * FROM 	allocateInfo b \
 union all \
 SELECT  decode(b.AMPM_GUBUN,'p','오전','오후') || ' 미배정 건수' AS CAR_REGNO,b.AMPM_GUBUN ,'-' emp_nm,0 counta,0 countp,0 AS tot_work_date \
    ,0 \
	,0 \
	,0 \
	,0 \
	,0 \
	,0 \
	,0 \
	,0 \
	,0 \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	,0  \
	FROM 	allocateInfo b,carInfo a
 
# 배차 기본
 mtr.h2.BUS_monthArrangeBasic_old= \
 WITH carInfo AS ( \
	SELECT '감차후 총 차량댓수' as CAR_REGNO,b.emp_nm,0 counta,0 countp,0 AS tot_work_date \
		, b.D1    , b.D2    , b.D3    , b.D4    , b.D5    , b.D6    , b.D7    , b.D8    , b.D9    , b.D10 \
	    , b.D11    , b.D12    , b.D13    , b.D14    , b.D15    , b.D16    , b.D17    , b.D18    , b.D19    , b.D20 \
	    , b.D21    , b.D22    , b.D23    , b.D24    , b.D25    , b.D26    , b.D27    , b.D28    , b.D29    , b.D30 \
	    , b.D31 \
	 FROM 	TBL_MONTH_ARRANGE_BASIC b \
	 WHERE 	b.company_no = '@companyNo' \
	 AND 	b.route_nm = '@routeNm' \
	 AND    b.init_seq = @initSeq \
	 AND    b.BASE_YM = '@baseYm' \
	 AND    b.DISPATCH_SEQ = 2  \
	 AND	b.CAR_REGNO  = '-' \
), allocateInfo AS ( \
	SELECT  '기사 배정 건수' as CAR_REGNO,'-' emp_nm,0 counta,0 countp,0 AS tot_work_date \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D1 ,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D1 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D2 ,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D2 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D3 ,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D3 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D4 ,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D4 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D5 ,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D5 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D6 ,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D6 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D7 ,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D7 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D8 ,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D8 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D9 ,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D9 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D10,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D10 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D11,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D11 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D12,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D12 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D13,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D13 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D14,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D14 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D15,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D15 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D16,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D16 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D17,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D17 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D18,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D18 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D19,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D19 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D20,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D20 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D21,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D21 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D22,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D22 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D23,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D23 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D24,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D24 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D25,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D25 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D26,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D26 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D27,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D27 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.D28,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) D28 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.d29,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) d29 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.d30,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) d30 \
		,sum(CASE WHEN instr(REGEXP_REPLACE(b.d31,'[#!]','*') ,'*') > 0 THEN 0 ELSE 1 END) d31 \
	 FROM 	TBL_MONTH_ARRANGE_DETAIL b \
	 WHERE 	b.company_no = '@companyNo' \
	 AND 	b.route_nm = '@routeNm' \
	 AND    b.init_seq = @initSeq \
	 AND    b.BASE_YM = '@baseYm' \
	 AND    b.DISPATCH_SEQ = 6  \
	 AND 	CAR_REGNO not like 'SP%' \
) \
 SELECT * FROM carInfo \
 union all \
  SELECT '감차후 총 운행횟수' as CAR_REGNO,b.emp_nm,0 counta,0 countp,0 AS tot_work_date \
	, b.D1 *2   , b.D2 *2    , b.D3  *2   , b.D4 *2    , b.D5 *2    , b.D6 *2    , b.D7 *2    , b.D8 *2    , b.D9 *2    , b.D10 *2 \
    , b.D11 *2    , b.D12 *2    , b.D13 *2    , b.D14 *2    , b.D15 *2    , b.D16 *2    , b.D17 *2    , b.D18 *2    , b.D19 *2    , b.D20 *2 \
    , b.D21 *2    , b.D22 *2    , b.D23 *2    , b.D24 *2    , b.D25 *2    , b.D26 *2    , b.D27 *2    , b.D28 *2    , b.D29 *2    , b.D30 *2 \
    , b.D31 *2 \
 FROM 	carInfo b \
 union all \
 SELECT  * FROM 	allocateInfo b \
 union all \
 SELECT  '기사 미배정 건수' as CAR_REGNO,'-' emp_nm,0 counta,0 countp,0 AS tot_work_date \
	,(a.d1  *2)- b.d1 \
	,(a.D2  *2)- b.D2 \
	,(a.D3  *2)- b.D3 \
	,(a.D4  *2)- b.D4 \
	,(a.D5  *2)- b.D5 \
	,(a.D6  *2)- b.D6 \
	,(a.D7  *2)- b.D7 \
	,(a.D8  *2)- b.D8 \
	,(a.D9  *2)- b.D9 \
	,(a.D10 *2)- b.D10 \
	,(a.D11 *2)- b.D11 \
	,(a.D12 *2)- b.D12 \
	,(a.D13 *2)- b.D13 \
	,(a.D14 *2)- b.D14 \
	,(a.D15 *2)- b.D15 \
	,(a.D16 *2)- b.D16 \
	,(a.D17 *2)- b.D17 \
	,(a.D18 *2)- b.D18 \
	,(a.D19 *2)- b.D19 \
	,(a.D20 *2)- b.D20 \
	,(a.D21 *2)- b.D21 \
	,(a.D22 *2)- b.D22 \
	,(a.D23 *2)- b.D23 \
	,(a.D24 *2)- b.D24 \
	,(a.D25 *2)- b.D25 \
	,(a.D26 *2)- b.D26 \
	,(a.D27 *2)- b.D27 \
	,(a.D28 *2)- b.D28 \
	,(a.d29 *2)- b.d29 \
	,(a.d30 *2)- b.d30 \
	,(a.d31 *2)- b.d31 \
 FROM 	allocateInfo b,carInfo a
  